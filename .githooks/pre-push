#!/usr/bin/env bash
# C3: Full Validation — pre-push hook for the app repo
# Runs go vet, go build, frontend build, and secret detection before push.
#
# Install: .githooks/setup.sh
# See: docs/design-decisions/DDR-055-deployment-automation.md
set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

info()  { echo -e "${GREEN}[pre-push]${NC} $*"; }
warn()  { echo -e "${YELLOW}[pre-push]${NC} $*"; }
error() { echo -e "${RED}[pre-push]${NC} $*"; }

# Only validate pushes to main branch
REMOTE="$1"
URL="$2"

PUSHING_TO_MAIN=false
while read -r local_ref local_oid remote_ref remote_oid; do
  if [[ "$remote_ref" == "refs/heads/main" ]]; then
    PUSHING_TO_MAIN=true
    break
  fi
done

if [ "$PUSHING_TO_MAIN" = "false" ]; then
  info "Not pushing to main — skipping validation"
  exit 0
fi

info "Pushing to main — running full validation (C3)"
echo ""

FAILED=0

# --- 1. Go formatting (gofmt) ---
info "Checking gofmt..."
UNFORMATTED=$(gofmt -l . 2>&1)
if [ -z "$UNFORMATTED" ]; then
  info "gofmt: PASSED"
else
  error "gofmt: FAILED — the following files need formatting:"
  echo "$UNFORMATTED"
  error "Run: gofmt -w ."
  FAILED=1
fi
echo ""

# --- 2. Go vet ---
info "Running go vet..."
if go vet ./... 2>&1; then
  info "go vet: PASSED"
else
  error "go vet: FAILED"
  FAILED=1
fi
echo ""

# --- 3. Go build (all Lambda entrypoints) ---
info "Running go build ./cmd/..."
if go build ./cmd/... 2>&1; then
  info "go build: PASSED"
else
  error "go build: FAILED"
  FAILED=1
fi
echo ""

# --- 4. Frontend build ---
FRONTEND_DIR="web/frontend"
if [ -d "$FRONTEND_DIR" ]; then
  info "Running frontend build..."
  pushd "$FRONTEND_DIR" > /dev/null

  if [ ! -d "node_modules" ]; then
    warn "node_modules not found, running npm ci..."
    npm ci --silent 2>&1
  fi

  if npm run build 2>&1; then
    info "Frontend build: PASSED"
  else
    error "Frontend build: FAILED"
    FAILED=1
  fi

  popd > /dev/null
else
  warn "Frontend directory not found at $FRONTEND_DIR — skipping"
fi
echo ""

# --- 5. Secret detection ---
info "Scanning for secrets in staged files..."
SECRET_PATTERNS=(
  'AKIA[0-9A-Z]{16}'            # AWS Access Key ID
  'aws_secret_access_key\s*='   # AWS Secret Key assignment
  'AIza[0-9A-Za-z_-]{35}'       # Google API Key
  'sk-[0-9a-zA-Z]{20,}'         # OpenAI / Stripe secret key
  'ghp_[0-9a-zA-Z]{36}'         # GitHub personal access token
  'gho_[0-9a-zA-Z]{36}'         # GitHub OAuth token
  'password\s*=\s*["\x27][^"\x27]{8,}' # Hardcoded passwords
)

SECRETS_FOUND=false
# Check files that will be pushed (diff between local and remote main)
PUSH_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only --cached)

for pattern in "${SECRET_PATTERNS[@]}"; do
  if echo "$PUSH_FILES" | xargs grep -lEn "$pattern" 2>/dev/null | grep -v -E '\.(md|txt|sample)$'; then
    error "Potential secret found matching pattern: $pattern"
    SECRETS_FOUND=true
  fi
done

if [ "$SECRETS_FOUND" = "true" ]; then
  error "Secret detection: FAILED — review flagged files above"
  FAILED=1
else
  info "Secret detection: PASSED"
fi
echo ""

# --- Summary ---
if [ "$FAILED" -ne 0 ]; then
  echo ""
  error "=== PRE-PUSH VALIDATION FAILED ==="
  error "Fix the issues above before pushing to main."
  error "To bypass (emergency only): git push --no-verify"
  exit 1
fi

info "=== ALL VALIDATIONS PASSED ==="
exit 0
